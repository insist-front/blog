(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{572:function(s,t,a){s.exports=a.p+"assets/img/hive-02.0c9216a4.jpg"},666:function(s,t,a){"use strict";a.r(t);var e=a(9),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"分区表"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#分区表"}},[s._v("#")]),s._v(" 分区表")]),s._v(" "),e("p",[s._v("分区表实际上就是对应一个 HDFS 文件系统上的独立的文件夹，该文件夹下是该分区所有的数据文件。Hive 中的分区就是分目录，把一个大的数据集根据业务需要分割成小的数据集。在查询时通过 WHERE 子句中的表达式选择查询所需要的指定的分区，这样的查询效率会提高很多。")]),s._v(" "),e("h3",{attrs:{id:"一级分区"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一级分区"}},[s._v("#")]),s._v(" 一级分区")]),s._v(" "),e("ol",[e("li",[e("p",[s._v("创建分区")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("create table dept_partition"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\ndeptno int, dname string, loc string\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\npartitioned by "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("day string"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nrow "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("format")]),s._v(" delimited fields terminated by "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("**注意：**分区字段不能是表中已经存在的数据，可以将分区字段看作表的伪列。")])]),s._v(" "),e("li",[e("p",[s._v("加载数据")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("load data "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" inpath "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/opt/module/hive/datas/dept_20200401.log'")]),s._v(" into table dept_partition partition"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("day"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200401'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nload data "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" inpath "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/opt/module/hive/datas/dept_20200402.log'")]),s._v(" into table dept_partition partition"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("day"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200402'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nload data "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" inpath "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/opt/module/hive/datas/dept_20200403.log'")]),s._v(" into table dept_partition partition"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("day"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200403'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("查询分区表中的数据")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 单分区")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from dept_partition where "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("day")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200401'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 多分区")]),s._v("\n "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from dept_partition where "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("day")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200401'")]),s._v("\n union\n "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from dept_partition where "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("day")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200402'")]),s._v("\n union\n "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from dept_partition where "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("day")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200403'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from dept_partition where "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("day")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200401'")]),s._v(" or "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("day")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200402'")]),s._v(" or "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("day")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200403'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("增加分区")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 单个")]),s._v("\nalter table dept_partition "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" partition"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("day"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200404'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 多个")]),s._v("\nalter table dept_partition "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" partition"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("day"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200405'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" partition"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("day"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200406'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("删除分区")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除单个分区")]),s._v("\nalter table dept_partition drop partition "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("day"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200406'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除多个分区")]),s._v("\nalter table dept_partition drop partition "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("day"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200404'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", partition"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("day"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200405'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("查看表有多少个分区")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("show partitions dept_partition"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("查看分区表结构")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("desc formatted dept_partition"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])])]),s._v(" "),e("h3",{attrs:{id:"二级分区"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二级分区"}},[s._v("#")]),s._v(" 二级分区")]),s._v(" "),e("ol",[e("li",[e("p",[s._v("创建")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("create table dept_partition2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n deptno int, dname string, loc string\n "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n partitioned by "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("day string, hour string"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n row "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("format")]),s._v(" delimited fields terminated by "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("加载数据到二级分区")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("load data "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" inpath \n"),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/opt/module/hive/datas/dept_20200401.log'")]),s._v(" into table\ndept_partition2 partition"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("day"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200401'")]),s._v(", "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("hour")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'12'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("查询分区数据")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from dept_partition2 where "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("day")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200401'")]),s._v(" and "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("hour")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'12'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("把数据直接上传到分区目录上，让分区表和数据产生关联的三种方式")]),s._v(" "),e("ol",[e("li",[e("p",[s._v("方式一：上传数据后修复")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("msck repair table dept_partition2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("方式二：上传数据后添加")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 上传数据")]),s._v("\ndfs -mkdir -p\n/user/hive/warehouse/mydb.db/dept_partition2/day"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("20200401")]),s._v("/hour"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nhive "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" dfs -put /opt/module/hive/datas/dept_20200401.log \n/user/hive/warehouse/mydb.db/dept_partition2/day"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("20200401")]),s._v("/hour"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加执行分区")]),s._v("\nalter table dept_partition2 "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" partition"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("day"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'201709'")]),s._v(",hour"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'14'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("方式三：创建文件夹后 load 数据到分区")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建文件")]),s._v("\ndfs -mkdir -p /user/hive/warehouse/mydb.db/dept_partition2/day"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("20200401")]),s._v("/hour"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 上传数据")]),s._v("\nload data "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" inpath "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/opt/module/hive/datas/dept_20200401.log'")]),s._v(" into table dept_partition2 partition"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("day"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20200401'")]),s._v(",hour"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'15'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])])])]),s._v(" "),e("h3",{attrs:{id:"动态分区"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#动态分区"}},[s._v("#")]),s._v(" 动态分区")]),s._v(" "),e("p",[s._v("关系型数据库中，对分区表 Insert 数据时候，数据库自动会根据分区字段的值，将数据插入到相应的分区中，Hive 中也提供了类似的机制，即动态分区(Dynamic Partition)，只不过，使用 Hive 的动态分区，需要进行相应的配置。")]),s._v(" "),e("p",[e("strong",[s._v("开启动态分区参数设置")])]),s._v(" "),e("ol",[e("li",[e("p",[s._v("开启动态分区功能（默认 true，开启）")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("hive.exec.dynamic.partition"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("设置为非严格模式（动态分区的模式，默认 strict，表示必须指定至少一个分区为静态分区，nonstrict 模式表示允许所有的分区字段都可以使用动态分区。）")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("hive.exec.dynamic.partition.mode"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nonstrict\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("在所有执行 MR 的节点上，最大一共可以创建多少个动态分区。默认 1000")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("在所有执行 MR 的节点上，最大一共可以创建多少个动态分区。默认 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("在每个执行 MR 的节点上，最大可以创建多少个动态分区。该参数需要根据实际的数据来设定。比如：源数据中包含了一年的数据，即 day 字段有 365 个值，那么该参数就需要设置成大于 365，如果使用默认值 100，则会报错。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("hive.exec.max.dynamic.partitions.pernode"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("整个 MR Job 中，最大可以创建多少个 HDFS 文件。默认 100000")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("hive.exec.max.created.files"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("100000")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("当有空分区生成时，是否抛出异常。一般不需要设置。默认 false")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("hive.error.on.empty.partition"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])])]),s._v(" "),e("p",[e("strong",[s._v("实操")])]),s._v(" "),e("ol",[e("li",[e("p",[s._v("创建目标分区表")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("create table dept_partition_dy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id int, name string"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \npartitioned by "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("loc int"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" row "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("format")]),s._v(" delimited fields terminated by "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("设置动态分区")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("insert into table dept_partition_dy partition"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("loc"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" deptno, dname, loc from dept"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("查看目标分区表的分区情况")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("show partitions dept_partition"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])])])])]),s._v(" "),e("h1",{attrs:{id:"分桶表"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#分桶表"}},[s._v("#")]),s._v(" 分桶表")]),s._v(" "),e("p",[s._v("分区提供一个隔离数据和优化查询的便利方式。不过，并非所有的数据集都可形成合理的分区。对于一张表或者分区，Hive 可以进一步组织成桶，也就是更为细粒度的数据范围划分")]),s._v(" "),e("p",[s._v("分桶是将数据集分解成更容易管理的若干部分的另一个技术。")]),s._v(" "),e("p",[s._v("分区针对的是数据的存储路径；分桶针对的是数据文件。")]),s._v(" "),e("p",[e("strong",[s._v("创建分桶表")])]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" stu_buck"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" name string"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("clustered")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" buckets\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" format delimited "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("strong",[s._v("查看表结构")])]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("desc formatted stu_buck"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nNum Buckets: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[e("strong",[s._v("加载数据")])]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("load data inpath "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/student.txt'")]),s._v(" into table stu_buck"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("strong",[s._v("查看")])]),s._v(" "),e("p",[e("img",{attrs:{src:a(572),alt:""}})]),s._v(" "),e("p",[e("strong",[s._v("分桶规则")])]),s._v(" "),e("p",[s._v("根据结果可知：Hive 的分桶采用对分桶字段的值进行哈希，然后除以桶的个数求余的方式决定该条记录存放在哪个桶当中")]),s._v(" "),e("p",[e("strong",[s._v("分桶操作注意事项")])]),s._v(" "),e("ol",[e("li",[e("p",[s._v("reduce 的个数设置为-1,让 Job 自行决定需要用多少个 reduce 或者将 reduce 的个数设置为大于等于分桶表的桶数")])]),s._v(" "),e("li",[e("p",[s._v("从 hdfs 中 load 数据到分桶表中，避免本地文件找不到问题")])]),s._v(" "),e("li",[e("p",[s._v("不要使用本地模式")])]),s._v(" "),e("li",[e("p",[s._v("insert方式将数据导入分桶表")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("insert into table stu_buck "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from student_insert\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])])]),s._v(" "),e("p",[e("strong",[s._v("抽样查询")])]),s._v(" "),e("p",[s._v("对于非常大的数据集，有时用户需要使用的是一个具有代表性的查询结果而不是全部结果。Hive 可以通过对表进行抽样来满足这个需求")]),s._v(" "),e("p",[s._v("语法: TABLESAMPLE(BUCKET x OUT OF y)")]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" stu_buck tablesample"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bucket "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("out")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("of")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" id"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("strong",[s._v("注意")]),s._v("：x 的值必须小于等于 y 的值，否则")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("FAILED: SemanticException "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Error "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10061")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Numerator should not be bigger \nthan denominator "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" sample clause "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" table stu_buck\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])])])}),[],!1,null,null,null);t.default=n.exports}}]);